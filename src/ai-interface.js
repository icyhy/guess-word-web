const axios = require('axios');

class ChineseAIInterface {
  constructor(apiKey = process.env.DEEPSEEK_API_KEY, enableLogging = process.env.ENABLE_DETAILED_LOGS === 'true') {
    this.apiKey = apiKey;
    this.enableLogging = enableLogging;
    this.apiUrl = 'https://api.deepseek.com/v1/chat/completions';

    // 中文AI模型的知识库（备用）
    this.knowledgeBase = {
      '苹果': ['水果', '红色', '绿色', '甜', '吃', '健康', '核心', '树', '派', '脆'],
      '香蕉': ['水果', '黄色', '钾', '皮', '钾', '奶昔', '猴子'],
      '电脑': ['科技', '屏幕', '键盘', '鼠标', '软件', '硬件', '互联网', '代码'],
      '书本': ['阅读', '页面', '故事', '知识', '图书馆', '文字', '作者', '小说'],
      '房子': ['家', '建筑', '房间', '家人', '居住', '结构', '屋顶', '门'],
      '汽车': ['车辆', '轮子', '驾驶', '引擎', '交通', '汽油', '道路', '速度'],
      '电话': ['通话', '手机', '通讯', '屏幕', '应用', '联系', '短信', '铃声'],
      '水': ['液体', '喝', 'H2O', '湿', '渴', '池塘', '海洋', '河流'],
      '太阳': ['光', '明亮', '天空', '白天', '温暖', '照耀', '恒星', '能量'],
      '树': ['植物', '叶子', '木头', '森林', '生长', '绿色', '自然', '枝条'],
      '狗': ['宠物', '动物', '吠叫', '忠诚', '小狗', '尾巴', '散步', '骨头'],
      '猫': ['宠物', '动物', '喵', '呼噜', '毛', '独立', '胡须', '爪子'],
      '鸟': ['飞', '翅膀', '羽毛', '巢', '唱歌', '天空', '喙', '蛋'],
      '鱼': ['水', '游泳', '海洋', '海', '缸', '鳃', '鳞片', '钓鱼'],
      '花': ['植物', '颜色', '气味', '花园', '美丽', '花瓣', '开花', '芬芳'],
      '椅子': ['坐', '家具', '腿', '背', '舒适', '桌子', '办公桌', '座位'],
      '桌子': ['表面', '家具', '腿', '平', '吃饭', '工作', '办公桌', '用餐'],
      '门': ['进入', '出去', '把手', '锁', '墙', '房间', '打开', '关闭'],
      '窗户': ['玻璃', '看', '光线', '框架', '开', '景色', '窗帘', '透明'],
      '床': ['睡觉', '休息', '枕头', '毯子', '卧室', '舒适', '梦', '床垫'],
      '钟表': ['时间', '小时', '分钟', '秒', '滴答', '闹钟', '手表', '安排'],
      '灯光': ['明亮', '灯', '灯泡', '暗', '照亮', '开关', '电力', '照耀'],
      '音乐': ['声音', '歌曲', '听', '聆听', '旋律', '乐器', '歌手', '跳舞'],
      '食物': ['吃', '饿', '餐', '营养', '味道', '美味', '烹饪', '盘子'],
      '饮料': ['渴', '液体', '玻璃杯', '水', '苏打', '果汁', '杯子', '吞咽'],
      '衬衫': ['衣服', '穿', '上衣', '袖子', '纽扣', '棉', '时尚', '衣柜'],
      '裤子': ['衣服', '穿', '下装', '牛仔裤', '腿', '拉链', '口袋', '丹宁布'],
      '鞋子': ['脚', '穿', '走', '鞋底', '鞋带', '靴子', '运动鞋', '高跟鞋'],
      '帽子': ['头', '戴', '帽', '遮阳', '太阳', '时尚', '帽檐', '无檐小便帽'],
      '包': ['携带', '物品', '口袋', '手', '肩膀', '背包', '钱包', '行李'],
      '笔': ['写', '墨水', '纸', '文具', '办公室', '学校', '画', '圆珠笔'],
      '铅笔': ['写', '铅', '橡皮', '尖', '纸', '学校', '画', '石墨'],
      '纸': ['白色', '张', '写', '打印', '新闻', '书籍', '杂志', '复印'],
      '钱': ['现金', '买', '花', '硬币', '钞票', '钱包', '购买', '货币'],
      '工作': ['职业', '办公室', '事业', '就业', '生意', '专业', '劳动', '任务'],
      '玩耍': ['乐趣', '游戏', '享受', '娱乐', '运动', '玩具', '休闲', '逗乐'],
      '快乐': ['喜悦', '微笑', '高兴', '积极', '愉快', '开心', '满足', '欣喜'],
      '悲伤': ['不开心', '哭泣', '沮丧', '消极', '阴郁', '忧郁', '心碎', '悲伤'],
      '大': ['巨大', '庞大', '宏伟', '巨大', '伟大', '巨人', '高', '尺寸'],
      '小': ['小', '微小', '迷你', '紧凑', '娇小', '简短', '矮', '窄'],
      '热': ['温度', '暖', '热', '辣', '夏天', '燃烧', '火', '沸腾'],
      '冷': ['温度', '凉', '冰冻', '冬天', '冰', '寒冷', '结冰', '霜'],
      '快': ['快速', '迅速', '速度', '敏捷', '匆忙', '赛跑', '动作', '加速'],
      '慢': ['逐渐', '延迟', '悠闲', '爬行', '蜗牛', '步伐', '放松', '稳定'],
      '上': ['上面', '高', '提升', '上升', '升起', '顶部', '抬升', '天堂'],
      '下': ['下面', '低', '降低', '下降', '落', '地面', '减少', '地板'],
      '左': ['方向', '右', '转', '边', '西', '手', '位置', '港'],
      '右': ['方向', '左', '正确', '边', '东', '手', '准确', '舷'],
      '前': ['前面', '向前', '面', '之前', '领先', '位置', '头', '前'],
      '后': ['后面', '背后', '向后', '向后', '脊柱', '位置', '尾', '后'],
      '学校': ['教育', '学习', '学生', '教师', '班级', '研究', '作业', '考试'],
      '老师': ['教育者', '导师', '学校', '教学', '学生', '课程', '班', '教授'],
      '学生': ['学习者', '学校', '学习', '学生', '教育', '班级', '作业', '学术'],
      '朋友': ['伙伴', '好友', '伙伴', '熟人', '关系', '社交', '信任', '支持'],
      '家庭': ['父母', '孩子', '亲戚', '家', '爱', '关系', '亲属', '家庭'],
      '爱': ['感情', '关怀', '情感', '浪漫', '感受', '心', '激情', '奉献'],
      '时间': ['钟', '小时', '时刻', '时间表', '持续时间', '时期', '手表', '场合'],
      '天': ['太阳', '光', '24小时', '早晨', '中午', '下午', '晚上', '日落'],
      '夜': ['暗', '月亮', '睡觉', '晚上', '星星', '床', '休息', '黄昏'],
      '周': ['7天', '星期一', '星期五', '星期六', '星期日', '工作日', '周末', '日历'],
      '月': ['日历', '30天', '一月', '二月', '三月', '四月', '五月', '六月'],
      '年': ['365天', '日历', '一月', '十二月', '季节', '年度', '生日', '周年'],
      '雨': ['水', '风暴', '湿', '云', '天气', '伞', '水坑', '春天'],
      '雪': ['白色', '冬天', '冷', '雪花', '冰', '天气', '暴风雪', '粉末'],
      '风': ['空气', '微风', '吹', '风暴', '天气', '阵风', '流动', '电流'],
      '火': ['火焰', '热', '燃烧', '热', '营火', '危险', '木材', '点燃'],
      '土': ['地球', '地面', '土壤', '世界', '土地', '污垢', '自然', '球'],
      '空气': ['呼吸', '氧气', '气体', '风', '大气', '呼吸', '无形', '元素'],
      '太空': ['宇宙', '星星', '宇宙', '虚空', '真空', '宇航员', '火箭', '轨道'],
      '星星': ['太空', '光', '夜晚', '天空', '星座', '银河系', '闪烁', '天体'],
      '月亮': ['夜晚', '天空', '月球', '撞击坑', '相位', '轨道', '卫星', '月牙'],
      '海洋': ['水', '海', '盐', '波浪', '深', '蓝色', '海洋', '潮汐'],
      '河流': ['水', '溪流', '流', '河岸', '桥', '鱼', '山谷', '支流'],
      '山': ['丘陵', '峰', '岩石', '高', '攀登', '坡', '山顶', '山脊'],
      '森林': ['树木', '树林', '自然', '野生动物', '绿色', '灌木', '木材', '林'],
      '公园': ['娱乐', '绿色', '户外', '游乐场', '自然', '公共', '长椅', '步行'],
      '城市': ['都市', '建筑', '人口', '大都市', '市中心', '摩天大楼', '交通', '混凝土'],
      '村庄': ['小', '镇', '乡村', '社区', '乡村', '小村', '邻里', '定居点'],
      '国家': ['民族', '州', '政府', '边界', '国旗', '首都', '公民', '主权'],
      '世界': ['地球', '星球', '全球', '国际', '人类', '宇宙', '文明', '人类'],
      '语言': ['说话', '词语', '英语', '西班牙语', '中文', '交流', '语法', '词汇'],
      '音乐': ['声音', '音符', '旋律', '节奏', '乐器', '歌曲', '歌手', '乐队'],
      '艺术': ['创意', '绘画', '画画', '美丽', '表达', '画廊', '博物馆', '工艺'],
      '科学': ['研究', '实验', '实验室', '发现', '知识', '理论', '事实', '学习'],
      '数学': ['数字', '计算', '代数', '几何', '公式', '问题', '解决', '方程'],
      '历史': ['过去', '事件', '时间线', '古代', '战争', '文化', '文明', '编年史'],
      '地理': ['地图', '国家', '山', '河', '大陆', '地点', '地方', '地形'],
      '体育': ['锻炼', '游戏', '团队', '竞争', '身体', '运动员', '比赛', '锦标赛'],
      '游戏': ['玩', '乐趣', '规则', '娱乐', '赢', '输', '得分', '挑战'],
      '电影': ['影片', '电影院', '演员', '故事', '观看', '剧院', '导演', '娱乐'],
      '音乐家': ['音乐', '演奏', '乐器', '歌曲', '乐队', '音乐会', '才华', '艺术家'],
      '演员': ['电影', '影片', '表演', '角色', '舞台', '角色', '剧院', '娱乐'],
      '医生': ['医学', '医院', '病人', '健康', '治疗', '手术', '护士', '诊所'],
      '工程师': ['技术', '设计', '建造', '技术', '问题', '解决方案', '数学', '创新'],
      '厨师': ['烹饪', '厨房', '食物', '餐厅', '食谱', '餐', '烹饪', '准备'],
      '艺术家': ['创造', '绘画', '画画', '艺术', '创意', '才华', '表达', '设计'],
      '作家': ['书', '故事', '小说', '文字', '作者', '小说', '文学', '写作'],
      '歌手': ['音乐', '声音', '歌曲', '表演', '音乐会', '麦克风', '歌词', '旋律'],
      '舞者': ['动作', '音乐', '表演', '优雅', '节奏', '舞台', '编舞', '表现力'],
      '运动员': ['体育', '比赛', '训练', '身体', '团队', '游戏', '冠军', '健身'],
      '早餐': ['早晨', '餐', '食物', '鸡蛋', '吐司', '咖啡', '麦片', '第一'],
      '午餐': ['中午', '餐', '食物', '三明治', '沙拉', '午后', '吃', '下午'],
      '晚餐': ['晚上', '餐', '食物', '晚餐', '夜晚', '吃', '家人', '餐厅'],
      '面包': ['小麦', '面粉', '烤', '吐司', '三明治', '烘焙', '面包', '卷'],
      '牛奶': ['牛', '白色', '喝', '钙', '盒子', '玻璃杯', '乳制品', '麦片'],
      '鸡蛋': ['鸡', '壳', '早餐', '煎蛋', '蛋白质', '蛋黄', '蛋白', '煎'],
      '米饭': ['谷物', '亚洲', '煮', '白', '棕色', '煮', '粘', '蒸'],
      '面条': ['意大利面', '亚洲', '汤', '意大利细面条', '通心粉', '煮', '长', '细'],
      '汤': ['液体', '热', '碗', '蔬菜', '肉汤', '鸡肉', '番茄', '温暖'],
      '沙拉': ['生菜', '蔬菜', '健康', '绿色', '调味料', '新鲜', '轻', '餐'],
      '披萨': ['意大利', '奶酪', '烤箱', '片', '意大利辣香肠', '面团', '融化', '美味'],
      '汉堡': ['牛肉', '汉堡', '面包', '肉', '快餐', '生菜', '番茄', '番茄酱'],
      '望远镜': ['观察', '星空', '放大', '天文学', '视野', '观测', '仪器', '遥远'],
      '显微镜': ['观察', '微观', '放大', '细胞', '科学', '实验室', '细节', '精密'],
      '实验室': ['实验', '科学', '研究', '设备', '测试', '化学', '生物学', '发现'],
      '大学': ['高等教育', '学习', '学位', '校园', '教授', '学生', '研究', '学术'],
      '毕业证书': ['学位', '毕业', '教育', '成就', '证书', '学校', '学习', '荣誉'],
      '护照': ['旅行', '出国', '身份', '签证', '边境', '机场', '旅游', '国际'],
      '假期': ['休假', '旅行', '放松', '度假', '休息', '娱乐', '外出', '享受'],
      '冒险': ['探险', '刺激', '挑战', '未知', '勇敢', '探索', '经历', '奇遇'],
      '字典': ['词汇', '定义', '查询', '学习', '参考', '词语', '解释', '知识'],
      '百科全书': ['知识', '信息', '全面', '学习', '参考', '百科', '资料', '教育'],
      '直升机': ['飞行', '螺旋桨', '航空', '运输', '救援', '空中', '旋翼', '机动'],
      '潜水艇': ['水下', '航行', '潜艇', '海洋', '军事', '潜航', '深海', '秘密'],
      '卫星': ['太空', '轨道', '通讯', '导航', '地球', '空间', '信号', '环绕'],
      '宇航员': ['太空', '航天', '宇航', '飞行', '宇航服', '国际空间站', '探索', '宇宙'],
      '火山': ['岩浆', '爆发', '熔岩', '地质', '喷发', '山坡', '危险', '地热'],
      '地震': ['震动', '地动', '摇晃', '地质', '灾害', '断层', '强度', '波'],
      '蝴蝶': ['昆虫', '翅膀', '美丽', '花朵', '飞行', '蜕变', '幼虫', '色彩'],
      '大象': ['大型', '鼻子', '象牙', '灰色', '动物', '草原', '群居', '智慧'],
      '长颈鹿': ['高', '脖子', '斑点', '非洲', '动物', '树叶', '哺乳动物', '奇特'],
      '鳄鱼': ['爬行动物', '水生', '锋利牙齿', '危险', '沼泽', '动物', '捕猎', '凶猛'],
      '袋鼠': ['跳跃', '澳大利亚', '袋子', '后腿', '动物', '哺乳动物', '独特', '灵活'],
      '企鹅': ['南极', '鸟类', '游泳', '黑白', '冰雪', '动物', '群体', '可爱'],
      '黑猩猩': ['灵长类', '聪明', '森林', '动物', '猿', '社群', '模仿', '活泼'],
      '犀牛': ['厚皮', '角', '大型', '动物', '草原', '哺乳动物', '强壮', '稀有'],
      '建筑学': ['设计', '建造', '结构', '美学', '规划', '空间', '艺术', '工程'],
      '摄影': ['拍照', '相机', '图像', '艺术', '记录', '瞬间', '视觉', '创作'],
      '天文学': ['星星', '行星', '宇宙', '太空', '观测', '科学', '望远镜', '星系'],
      '化学': ['分子', '反应', '实验', '元素', '科学', '实验室', '合成', '物质'],
      '物理': ['力', '能量', '运动', '科学', '定律', '实验', '物质', '现象'],
      '生物': ['生命', '细胞', '进化', '科学', '实验', '生态', '遗传', '有机'],
      '数学': ['计算', '公式', '逻辑', '证明', '数字', '运算', '定理', '分析'],
      '哲学': ['思辨', '思想', '存在', '伦理', '知识', '理性', '真理', '智慧'],
      '交响乐': ['管弦', '乐团', '古典', '音乐', '指挥', '乐器', '和谐', '宏大'],
      '管弦乐队': ['音乐', '乐器', '演出', '合作', '指挥', '合奏', '交响', '表演'],
      '芭蕾': ['舞蹈', '优雅', '技巧', '表演', '足尖', '艺术', '古典', '音乐'],
      '雕塑': ['立体', '造型', '艺术', '石头', '铜像', '创作', '三维', '工艺'],
      '绘画': ['颜料', '画笔', '艺术', '创作', '平面', '色彩', '表现', '技法'],
      '文学': ['文字', '作品', '创作', '小说', '诗歌', '表达', '思想', '语言'],
      '诗歌': ['韵律', '抒情', '文学', '意象', '情感', '节奏', '语言', '美'],
      '小说': ['故事', '虚构', '情节', '人物', '文学', '叙述', '想象', '篇章'],
      '餐厅': ['美食', '用餐', '服务', '菜单', '厨师', '就餐', '社交', '品味'],
      '面包店': ['烘焙', '面包', '糕点', '面粉', '制作', '新鲜', '甜品', '早餐'],
      '超市': ['购物', '商品', '食品', '日用品', '零售', '顾客', '货架', '便民'],
      '药店': ['药品', '健康', '医疗', '处方', '保健品', '药师', '治疗', '康复'],
      '医院': ['治疗', '医疗', '病人', '医生', '护理', '急救', '健康', '康复'],
      '图书馆': ['书籍', '阅读', '知识', '安静', '学习', '借阅', '文化', '教育'],
      '博物馆': ['展览', '文物', '历史', '文化', '教育', '参观', '艺术', '收藏'],
      '剧院': ['表演', '戏剧', '观众', '舞台', '艺术', '演出', '娱乐', '文化'],
      '吉他': ['弦乐', '弹奏', '音乐', '拨片', '和弦', '民谣', '摇滚', '旋律'],
      '钢琴': ['键盘', '古典', '音乐', '黑白键', '优雅', '独奏', '伴奏', '艺术'],
      '小提琴': ['弓弦', '高音', '音乐', '演奏', '古典', '优雅', '技巧', '音色'],
      '鼓': ['打击', '节奏', '音乐', '敲击', '节拍', '强劲', '伴奏', '激昂'],
      '小号': ['铜管', '嘹亮', '音乐', '铜质', '爵士', '军乐', '高音', '明亮'],
      '萨克斯': ['木管', '爵士', '音乐', '铜制', '柔和', '即兴', '蓝调', '风情'],
      '长笛': ['木管', '吹奏', '音乐', '横吹', '轻盈', '优雅', '清澈', '灵动'],
      '口琴': ['吹奏', '便携', '音乐', '小', '蓝调', '民间', '即兴', '抒情']
    };
  }

  /**
   * 通过DeepSeek API进行中文词语猜测
   * @param {string} description - 用户的描述
   * @param {Array<string>} allDescriptions - 本轮所有的描述
   * @returns {Promise<string>} - AI猜测的词语
   */
  async guessWord(description, allDescriptions = []) {
    // 如果没有API密钥，使用备用逻辑
    if (!this.apiKey) {
      console.warn('DeepSeek API密钥未设置，使用备用逻辑');
      return this.fallbackGuess(description, allDescriptions);
    }

    // 准备完整的上下文
    const context = allDescriptions.length > 0
      ? allDescriptions.join('。')
      : description;

    // 构建提示词
    const prompt = `你是一个专业的词语猜测助手。现在进行一个猜词游戏：我会给你对某个中文词语的描述，你需要根据描述精准地猜出这个词语。

重要规则：
1. 仔细分析描述中的线索
2. 输出最符合描述的中文词语
3. 只输出词语本身，不要有任何解释、标点符号或额外内容
4. 词语长度通常为2-4个汉字
5. 词语必须是名词 (如：苹果、电脑、学校等)，绝不要猜测动词、形容词或助词
6. 优先考虑日常生活中常见的事物

词语描述: ${context}`;

    try {
      const requestData = {
        model: "deepseek-chat",
        messages: [
          {
            role: "user",
            content: prompt
          }
        ],
        temperature: 0.7,
        max_tokens: 20,
        stream: false
      };

      const requestHeaders = {
        'Authorization': `Bearer ${this.apiKey}`,
        'Content-Type': 'application/json'
      };

      if (this.enableLogging) {
        console.log('--- DeepSeek API Request ---');
        console.log('URL:', this.apiUrl);
        console.log('Headers:', JSON.stringify(requestHeaders, null, 2));
        console.log('Body:', JSON.stringify(requestData, null, 2));
      }

      const response = await axios.post(this.apiUrl, requestData, {
        headers: requestHeaders
      });

      if (this.enableLogging) {
        console.log('--- DeepSeek API Response ---');
        console.log('Status:', response.status);
        console.log('Data:', JSON.stringify(response.data, null, 2));
      }

      let guess = response.data.choices[0]?.message?.content?.trim() || '';

      // 清理响应，移除可能的多余字符
      guess = guess.replace(/[，。！？、]/g, '').trim();

      // 如果AI返回的是句子而非单词，提取可能的名词
      if (guess.includes(' ')) {
        // 尝试从句子中提取名词
        const words = guess.split(/[\s，。！？、]/);
        for (const word of words) {
          if (word.length >= 2 && word.length <= 4) { // 中文词通常2-4个字
            guess = word;
            break;
          }
        }
      }

      console.log(`AI猜测: ${guess}`);
      return guess || this.getRandomCommonWord();
    } catch (error) {
      console.error('DeepSeek API调用失败:', error.message);
      if (error.response) {
        console.error('响应数据:', error.response.data);
      }
      // API调用失败时使用备用逻辑
      return this.fallbackGuess(description, allDescriptions);
    }
  }

  /**
   * 备用猜测逻辑
   * @param {string} description - 用户的描述
   * @param {Array<string>} allDescriptions - 本轮所有的描述
   * @returns {string} - 猜测的词语
   */
  fallbackGuess(description, allDescriptions = []) {
    // 将描述转换为关键词
    const context = allDescriptions.length > 0
      ? allDescriptions.join('。')
      : description;

    const keywords = context
      .replace(/[^\u4e00-\u9fa5\w\s]/g, ' ')
      .split(/\s+/)
      .filter(k => k.length > 0);

    // 找出与关键词匹配最多的词语
    let bestMatch = '';
    let maxScore = 0;

    for (const [word, relatedWords] of Object.entries(this.knowledgeBase)) {
      let score = 0;

      // 检查描述中的关键词是否出现在知识库中
      for (const keyword of keywords) {
        if (keyword.length < 2) continue; // 跳过单字符

        if (relatedWords.includes(keyword)) {
          score += 2; // 匹配相关词得2分
        }

        // 检查是否部分匹配
        for (const relatedWord of relatedWords) {
          if (relatedWord.includes(keyword) || keyword.includes(relatedWord)) {
            score += 1; // 部分匹配得1分
          }
        }
      }

      if (score > maxScore) {
        maxScore = score;
        bestMatch = word;
      }
    }

    // 如果没有找到合适的匹配，返回一个常见的词
    if (maxScore === 0) {
      return this.getRandomCommonWord();
    }

    return bestMatch;
  }

  /**
   * 随机获取一个常见词语
   * @returns {string} - 随机词语
   */
  getRandomCommonWord() {
    const commonWords = Object.keys(this.knowledgeBase).slice(0, 50); // 前50个常见词
    return commonWords[Math.floor(Math.random() * commonWords.length)];
  }

  /**
   * 设置API密钥
   * @param {string} apiKey - DeepSeek API密钥
   */
  setApiKey(apiKey) {
    this.apiKey = apiKey;
  }
}

module.exports = ChineseAIInterface;